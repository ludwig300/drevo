# AGENTS.md — Генератор генеалогического древа (Python)

Этот файл описывает, **что именно нужно реализовать** в проекте “Генеалогическое древо” и **как агенту/разработчику** работать с репозиторием: архитектура, требования, критерии готовности, договорённости по коду.

---

## 1) Цель продукта

Сделать программу, в которую пользователь **вводит данные о родственниках**, а программа **строит графическое генеалогическое древо** в виде блоков (карточек людей) со связями.

Ключевая ценность:
- быстро добавить людей и связи;
- получить аккуратную схему, пригодную для **сохранения в PDF** и **печати**.

---

## 2) Основные сценарии пользователя (User Flows)

### 2.1 Создать древо с нуля
1. Пользователь создаёт новый проект.
2. Добавляет первого человека (или пару супругов).
3. Добавляет родителей/детей/супругов.
4. Программа автоматически располагает блоки по поколениям.
5. Пользователь при необходимости подправляет расположение блоков (перетаскиванием).
6. Экспортирует в PDF и печатает.

### 2.2 Редактировать существующий проект
1. Открывает ранее сохранённый проект.
2. Меняет данные, добавляет фото, добавляет людей/связи.
3. Снова экспортирует в PDF.

### 2.3 Быстрый экспорт для печати
1. Пользователь выбирает формат бумаги (A4/A3 и т.п.), ориентацию, поля.
2. При необходимости включает “постерную печать” (разбиение на несколько страниц).
3. Получает PDF.

---

## 3) Функциональные требования (MVP)

### 3.1 Карточки людей (блоки)
Каждая карточка отображает:
- Фото (опционально) — миниатюра/аватар.
- ФИО (или краткое имя).
- Краткая информация (по настройке, например):
  - годы жизни (рождения/смерти) или дата рождения;
  - город/страна (опционально);
  - краткая подпись/роль (опционально).
- Внутренний идентификатор (в UI не показывать, только для файла).

Карточка должна:
- перетаскиваться мышью (ручная корректировка позиции);
- масштабироваться вместе со сценой (zoom);
- поддерживать контекстное меню (редактировать/удалить/добавить связь).

### 3.2 Типы родственных связей (минимум)
Обязательные типы:
- **родитель → ребёнок** (биологический по умолчанию)
- **супруг/супруга** (партнёр)

Опционально (если успеваем в MVP):
- усыновление/удочерение (тип родительства)
- развод/статус союза (хранить, но не обязательно рисовать)

Отображение на схеме:
- связи “родитель–ребёнок” — вертикальные/диагональные линии (иерархия поколений);
- связь “супруги” — горизонтальная линия между карточками в одном поколении.

### 3.3 Редактор данных
Должен быть UI-формуляр для ввода/редактирования:
- имя (ФИО / короткое имя для карточки);
- пол (опционально, для будущих фич);
- дата рождения/смерти (опционально);
- заметка (краткая);
- фото (загрузка файла, предпросмотр, обрезка/масштабирование — по возможности).

### 3.4 Авто-раскладка (layout)
Минимум:
- автопостроение по поколениям сверху вниз (старшие сверху);
- разумные отступы, чтобы линии не “слипались”.

Если автолэйаут сложен — допускается:
- “пересчитать расположение” отдельной кнопкой;
- ручная корректировка пользователем.

### 3.5 Сохранение/загрузка проекта
- Сохранить проект в файл (рекомендуемый формат: `.json` + папка `assets/` для картинок).
- Открыть проект обратно без потери связей, позиций и фото.

### 3.6 Экспорт в PDF и печать
Обязательно:
- экспорт в **PDF** с качественным выводом (текст читаемый, линии чёткие, фото встраиваются);
- выбор: формат бумаги (A4/A3), ориентация, поля;
- “уместить на страницу” (масштабирование).

Желательно:
- “постерная печать” — разбить большую схему на несколько страниц A4 (с перекрытием/метками).

---

## 4) Нефункциональные требования

- Платформы: Windows/macOS/Linux (желательно).
- Производительность: дерево до ~300 человек должно оставаться рабочим (панорамирование/масштаб).
- Надёжность: проект не должен ломаться при отсутствии фото (фото опционально).
- Данные: локально, без облака (по умолчанию).
- Печать: вывод должен быть стабильным и предсказуемым (WYSIWYG).

---

## 5) Рекомендуемый стек (Python)

### Вариант A (рекомендуемый): Desktop GUI на Qt
- Python 3.11+
- **PySide6** (или PyQt6) для интерфейса
- `QGraphicsScene/QGraphicsView` для рисования блоков и связей
- Экспорт/печать:
  - `QPdfWriter` или `QPrinter` (режим PDF)
  - `QPainter` для рендера сцены

Плюсы: интерактивная схема, перетаскивание, нормальная печать.
Минусы: чуть тяжелее старт.

### Вариант B (упрощённый): генерация через Graphviz
- Python + `graphviz` (DOT) → рендер сразу в PDF
- UI может быть минимальным (формы + кнопка “Сгенерировать”)

Плюсы: быстро получить красивый layout.
Минусы: сложно сделать интерактивное редактирование на схеме.

> Для данного ТЗ предпочтителен Вариант A, потому что пользователь ожидает “блоки” и визуальное редактирование.

---

## 6) Архитектура проекта (предложение)

```
geneatree/
  src/geneatree/
    app.py
    ui/
      main_window.py
      dialogs.py
    model/
      entities.py        # Person, Relationship, TreeProject
      storage.py         # load/save JSON, управление assets
      validation.py
    scene/
      graphics_items.py  # PersonItem, EdgeItem
      layout.py          # алгоритм раскладки
      export_pdf.py      # экспорт в PDF (рендер сцены)
    resources/
      icons/
  tests/
  pyproject.toml
  README.md
  AGENTS.md
```

Слои:
- **Model**: данные (люди, связи, проект, позиции).
- **Scene/Graphics**: визуальные элементы и синхронизация с моделью.
- **UI**: окна/диалоги/меню.
- **Export**: PDF/печать.

---

## 7) Модель данных

### 7.1 Person
Поля (минимум):
- `id: str` (UUID)
- `display_name: str`
- `full_name: str | null`
- `birth_date: str | null` (ISO `YYYY-MM-DD` или просто год `YYYY`)
- `death_date: str | null`
- `note: str | null`
- `photo_path: str | null` (относительно проекта, например `assets/uuid.jpg`)
- `pos: {x: float, y: float}` (позиция на сцене для ручной правки)
- `style: {...}` (опционально: цвет рамки/фон/шрифт)

### 7.2 Relationship
- `id: str` (UUID)
- `type: "parent" | "spouse"`
- `from_id: str` (родитель или первый супруг)
- `to_id: str` (ребёнок или второй супруг)
- `meta: {...}` (опционально: “adopted”: true, даты брака и т.п.)

### 7.3 TreeProject
- `project_version: int`
- `people: Person[]`
- `relationships: Relationship[]`
- `settings`:
  - формат страницы по умолчанию
  - стиль карточек (размеры, отступы)
  - параметры лэйаута
- `assets_manifest` (опционально)

---

## 8) Правила отображения

- Каждая карточка имеет фиксированный минимальный размер.
- Фото: вписывать в квадрат/прямоугольник с сохранением пропорций.
- Текст: перенос строк, ограничение по высоте (лишнее — троеточие).
- Линии связей:
  - должны обновляться при перемещении карточек;
  - предпочтительно рисовать “ортогонально” (ломаной), чтобы выглядело аккуратнее.

---

## 9) Экспорт в PDF: требования к реализации

- Экспорт должен поддерживать:
  - “уместить на 1 страницу” (fit-to-page)
  - заданные поля
  - выбор DPI/качества картинок (например 150–300 DPI)
- Если дерево больше страницы:
  - режим “постер” (tile) — разбиение на N страниц
  - желательно добавить метки совмещения (не обязательно в MVP)
- В PDF шрифты и линии должны быть чёткими (вектор, где возможно).

---

## 10) Критерии готовности (Acceptance Criteria)

MVP считается готовым, если:
1. Можно добавить человека, отредактировать его данные, прикрепить фото.
2. Можно создать связи:
   - родитель–ребёнок
   - супруги
3. На сцене отображаются карточки и линии связей.
4. Есть автолэйаут (минимальный) + возможность ручного перетаскивания.
5. Проект сохраняется и загружается без потерь.
6. Экспорт в PDF работает и результат пригоден для печати (проверка на A4).

---

## 11) План разработки (по этапам)

### Этап 1 — Основа (данные + UI формы)
- Модель данных `Person/Relationship/TreeProject`
- Сохранение/загрузка JSON
- Главное окно, панель инструментов, диалог редактирования человека

### Этап 2 — Визуализация
- `QGraphicsScene` с `PersonItem`
- `EdgeItem` для связей
- Перетаскивание, zoom/pan

### Этап 3 — Layout
- Простейшая раскладка по поколениям
- Кнопка “Пересчитать расположение”

### Этап 4 — PDF/печать
- Экспорт в PDF (fit-to-page)
- Опции страницы

### Этап 5 — Полировка
- Постерная печать (tile)
- Улучшение внешнего вида линий/карточек
- Горячие клавиши, undo/redo (если успеваем)

---

## 12) Стандарты кода и качества

- Форматирование: `ruff format` (или `black`) — выбрать один вариант и придерживаться.
- Линтер: `ruff`
- Тесты: `pytest` (минимум на модель/сохранение/загрузку/лейаут вычисления)
- Типизация: `mypy` (опционально, но желательно)

### Принципы
- Логика лэйаута и экспорт должны быть **без UI-зависимостей**, по возможности (легче тестировать).
- UI не должен хранить бизнес-логику (только вызывать сервисы).

---

## 13) Команды разработчика (пример)

> Актуализировать под выбранный стек и `pyproject.toml`.

- Установка:
  - `python -m venv .venv`
  - `pip install -e .[dev]`
- Запуск:
  - `python -m geneatree`
- Тесты:
  - `pytest -q`
- Линт:
  - `ruff check .`
- Форматирование:
  - `ruff format .`

---

## 14) Что НЕ делать в MVP (Non-goals)

- Онлайн-синхронизация/аккаунты/облако.
- Полноценная поддержка GEDCOM (можно добавить позже).
- Сложные типы родства (кузены, степени родства) как вычисляемая логика — пока только хранение/визуализация связей.
- Фоторедактор уровня Photoshop — достаточно обрезки/масштабирования или просто “вписать”.

---

## 15) Риски и упрощения

- Авто-раскладка генеалогии — сложная тема (особенно с несколькими браками).
  - Допускается MVP-раскладка “достаточно хорошая” + ручная правка.
- Большие деревья могут выходить за пределы страницы:
  - обязательный fit-to-page;
  - постерный режим — желательно, но можно после MVP.

---

## 16) Вопросы для будущих версий (Backlog)

- Импорт/экспорт GEDCOM
- Темы оформления (цвета поколений, стили карточек)
- Поиск по людям
- Отображение “веток” и скрытие/сворачивание поддеревьев
- Расчёт степеней родства (например “двоюродный брат”)
- Версионирование проекта и автосохранение
